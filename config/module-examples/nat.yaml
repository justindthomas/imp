name: nat
display_name: "Deterministic NAT (det44)"
description: "Carrier-grade NAT for IPv4 using deterministic mapping"

# How this module connects to core VPP
topology:
  connections:
    - name: internal
      purpose: "Receives traffic from internal networks via ABF"
      create_lcp: false
    - name: external
      purpose: "Returns translated traffic toward external gateway"
      create_lcp: true  # Expose to Linux for FRR route visibility

# VPP plugins
plugins:
  - memif_plugin.so
  - det44_plugin.so
disable_plugins:
  - dpdk_plugin.so

# CPU requirements (for auto-allocation from module_pool)
cpu:
  min_cores: 0     # Can run without dedicated cores
  ideal_cores: 2   # Main + 1 worker if available

# Configuration schema (what fields can be set in router.json)
config_schema:
  bgp_prefix:
    type: string
    format: ipv4_cidr
    description: "Prefix to announce via BGP covering all NAT pools"
  mappings:
    type: array
    item_schema:
      source_network: {type: string, format: ipv4_cidr}
      nat_pool: {type: string, format: ipv4_cidr}
  bypass_pairs:
    type: array
    item_schema:
      source: {type: string, format: ipv4_cidr}
      destination: {type: string, format: ipv4_cidr}

# Show commands exposed in CLI and agent
show_commands:
  - name: sessions
    vpp_command: "show det44 sessions"
    description: "Show active NAT sessions"
  - name: mappings
    vpp_command: "show det44 mappings"
    description: "Show det44 pool mappings"
  - name: interfaces
    vpp_command: "show det44 interfaces"
    description: "Show det44 interface configuration"

# ABF rules: how core steers traffic to this module
abf:
  source: internal_interfaces  # Apply to all internal interfaces
  exclude:
    - container_network        # Don't NAT container traffic
    - bypass_pairs             # Respect bypass rules from config

# Routing: prefixes to announce via BGP and route to module
routing:
  advertise:
    - config_field: bgp_prefix      # Field name in module.config
      via_connection: external      # Route via external connection
      address_family: ipv4

# CLI commands for configuring this module
commands:
  # Mappings management
  - path: mappings/add
    description: "Add a NAT mapping (internal network to public pool)"
    action: array_append
    target: mappings
    params:
      - name: source_network
        type: ipv4_cidr
        prompt: "Source network (CIDR, e.g., 10.0.0.0/24)"
      - name: nat_pool
        type: ipv4_cidr
        prompt: "NAT pool (CIDR, e.g., 23.177.24.96/30)"

  - path: mappings/delete
    description: "Delete a NAT mapping"
    action: array_remove
    target: mappings
    key: source_network

  - path: mappings/list
    description: "List NAT mappings"
    action: array_list
    target: mappings
    format: "{source_network} -> {nat_pool}"

  # Bypass rules management
  - path: bypass/add
    description: "Add a bypass rule (traffic that skips NAT)"
    action: array_append
    target: bypass_pairs
    key: [source, destination]  # Compound key - same source can have multiple destinations
    params:
      - name: source
        type: ipv4_cidr
        prompt: "Source network (CIDR)"
      - name: destination
        type: ipv4_cidr
        prompt: "Destination network (CIDR)"

  - path: bypass/delete
    description: "Delete a bypass rule"
    action: array_remove
    target: bypass_pairs

  - path: bypass/list
    description: "List bypass rules"
    action: array_list
    target: bypass_pairs
    format: "{source} -> {destination}"

  # BGP prefix
  - path: set-prefix
    description: "Set the BGP announcement prefix"
    action: set_value
    target: bgp_prefix
    params:
      - name: prefix
        type: ipv4_cidr
        prompt: "Prefix to announce via BGP (CIDR)"

  - path: show
    description: "Show NAT module configuration"
    action: show
    target: ""

# VPP commands (Jinja2 template rendered with module context)
# Available variables: module.connections, module.config, external, internal, container, etc.
vpp_commands: |
  det44 plugin enable
  {% set int_conn = module.connections | selectattr('name', 'eq', 'internal') | first %}
  {% set ext_conn = module.connections | selectattr('name', 'eq', 'external') | first %}
  set interface det44 inside memif{{ int_conn.socket_id }}/0 outside memif{{ ext_conn.socket_id }}/0

  {% for mapping in module.config.mappings %}
  det44 add in {{ mapping.source_network }} out {{ mapping.nat_pool }}
  {% endfor %}

  # Routes back to core
  ip route add 0.0.0.0/0 via {{ ext_conn.core_ip }} memif{{ ext_conn.socket_id }}/0
  {% for mapping in module.config.mappings %}
  ip route add {{ mapping.source_network }} via {{ int_conn.core_ip }} memif{{ int_conn.socket_id }}/0
  {% endfor %}
