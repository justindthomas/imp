# VPP Core Commands
# Generated by configure-router.py

lcp lcp-sync on
lcp lcp-auto-subint on

# Dataplane interfaces
{% for iface in interfaces %}
# Interface: {{ iface.name }} ({{ iface.iface }})
lcp create {{ iface.name }} host-if {{ iface.name }}
set interface state {{ iface.name }} up
{% for addr in iface.ipv4 %}
set interface ip address {{ iface.name }} {{ addr.address }}/{{ addr.prefix }}
{% endfor %}
{% for addr in iface.ipv6 %}
set interface ip address {{ iface.name }} {{ addr.address }}/{{ addr.prefix }}
{% endfor %}
set interface mtu {{ iface.mtu }} {{ iface.name }}
{% if iface.subinterfaces %}

# {{ iface.name }} sub-interfaces (L3 VLAN termination)
{% for sub in iface.subinterfaces %}
create sub-interfaces {{ iface.name }} {{ sub.vlan_id }}
set interface state {{ iface.name }}.{{ sub.vlan_id }} up
{% if sub.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create {{ iface.name }}.{{ sub.vlan_id }} host-if {{ iface.name }}-v{{ sub.vlan_id }}
{% endif %}
{% if sub.ipv4 %}
set interface ip address {{ iface.name }}.{{ sub.vlan_id }} {{ sub.ipv4 }}/{{ sub.ipv4_prefix }}
{% endif %}
{% if sub.ipv6 %}
set interface ip address {{ iface.name }}.{{ sub.vlan_id }} {{ sub.ipv6 }}/{{ sub.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}

{% endfor %}
{% if loopbacks %}
# Loopback interfaces
{% for lo in loopbacks %}
create loopback interface instance {{ lo.instance }}
set interface state loop{{ lo.instance }} up
{% if lo.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create loop{{ lo.instance }} host-if lo{{ lo.instance }}
{% endif %}
{% if lo.ipv4 %}
set interface ip address loop{{ lo.instance }} {{ lo.ipv4 }}/{{ lo.ipv4_prefix }}
{% endif %}
{% if lo.ipv6 %}
set interface ip address loop{{ lo.instance }} {{ lo.ipv6 }}/{{ lo.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}
{% if bvi_domains %}

# BVI (Bridge Virtual Interface) domains
{% for bvi in bvi_domains %}
# Bridge domain {{ bvi.bridge_id }}: {{ bvi.name }}
create loopback interface instance {{ bvi.bridge_id }}
set interface state loop{{ bvi.bridge_id }} up
create bridge-domain {{ bvi.bridge_id }}
set interface l2 bridge loop{{ bvi.bridge_id }} {{ bvi.bridge_id }} bvi
{% for member in bvi.members %}
{% if member.vlan_id %}
create sub-interfaces {{ member.interface }} {{ member.vlan_id }}
set interface state {{ member.interface }}.{{ member.vlan_id }} up
set interface l2 bridge {{ member.interface }}.{{ member.vlan_id }} {{ bvi.bridge_id }}
{% else %}
set interface l2 bridge {{ member.interface }} {{ bvi.bridge_id }}
{% endif %}
{% endfor %}
{% if bvi.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create loop{{ bvi.bridge_id }} host-if bvi{{ bvi.bridge_id }}
{% endif %}
{% if bvi.ipv4 %}
set interface ip address loop{{ bvi.bridge_id }} {{ bvi.ipv4 }}/{{ bvi.ipv4_prefix }}
{% endif %}
{% if bvi.ipv6 %}
set interface ip address loop{{ bvi.bridge_id }} {{ bvi.ipv6 }}/{{ bvi.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}

{% if modules %}
# Module memif connections (master side)
{% for module in modules if module.enabled %}
# Memif connections to {{ module.name }} ({{ module.display_name }})
{% for conn in module.connections %}
create memif socket id {{ conn.socket_id }} filename {{ conn.socket_path }}
create interface memif id 0 socket-id {{ conn.socket_id }} master
{% if conn.create_lcp %}
lcp create memif{{ conn.socket_id }}/0 host-if memif-{{ module.name }}-{{ conn.name[:3] }}
{% endif %}
set interface state memif{{ conn.socket_id }}/0 up
set interface ip address memif{{ conn.socket_id }}/0 {{ conn.core_ip }}/{{ conn.prefix }}
{% endfor %}
{% endfor %}

# Dynamic ABF for modules
{% set abf_id = namespace(value=0) %}
{% for module in modules if module.enabled and module.abf %}
{% if module.config.source_interfaces is defined and module.config.source_interfaces %}
# ABF rules for {{ module.name }}: steering traffic from specified interfaces
{% for iface_name in module.config.source_interfaces %}
{% set iface = interfaces | selectattr('name', 'eq', iface_name) | first %}
{% if iface %}
{% for network in iface.networks %}
{# Build ACL: deny excludes, permit source network #}
set acl-plugin acl {% for excl in module.abf.exclude %}{% if excl == 'container_network' %}deny src {{ network }} dst {{ container.network }}, {% elif excl == 'bypass_pairs' %}{% for bp in module.config.bypass_pairs %}deny src {{ bp.source }} dst {{ bp.destination }}, {% endfor %}{% endif %}{% endfor %}permit src {{ network }}
{% set target_conn = module.connections | selectattr('name', 'eq', 'internal') | first %}
abf policy add id {{ abf_id.value }} acl {{ abf_id.value }} via {{ target_conn.module_ip }} memif{{ target_conn.socket_id }}/0
abf attach ip4 policy {{ abf_id.value }} {{ iface.name }}
{% set abf_id.value = abf_id.value + 1 %}
{% endfor %}
{% endif %}
{% endfor %}
{% elif module.abf.match == 'destination_prefix' %}
# ABF rules for {{ module.name }}: match destination prefix
set acl-plugin acl permit dst {{ module.config[module.abf.prefix_field] }}
{% set target_conn = module.connections | first %}
abf policy add id {{ abf_id.value }} acl {{ abf_id.value }} via {{ target_conn.module_ip }} memif{{ target_conn.socket_id }}/0
{% for iface in interfaces %}
abf attach ip6 policy {{ abf_id.value }} {{ iface.name }}
{% endfor %}
{% set abf_id.value = abf_id.value + 1 %}
{% endif %}
{% endfor %}

# Routes for module return traffic
{% for module in modules if module.enabled %}
{% if module.name == 'nat' and module.config.mappings is defined %}
# Routes for NAT pool return traffic (via NAT module)
{% set ext_conn = module.connections | selectattr('name', 'eq', 'external') | first %}
{% if ext_conn %}
{% for mapping in module.config.mappings %}
ip route add {{ mapping.nat_pool }} via {{ ext_conn.module_ip }} memif{{ ext_conn.socket_id }}/0
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{# Static routes are now managed by FRR and synced to VPP via linux_cp #}
{% if vlan_passthrough %}

# VLAN pass-through (L2 cross-connect between interfaces)
{% for v in vlan_passthrough %}
{% if v.inner_vlan %}
# QinQ VLAN {{ v.vlan_id }}.{{ v.inner_vlan }} {{ v.from_interface }} <-> {{ v.to_interface }}
create sub-interface {{ v.from_interface }} {{ v.vlan_id }} inner-dot1q {{ v.inner_vlan }}
create sub-interface {{ v.to_interface }} {{ v.vlan_id }} inner-dot1q {{ v.inner_vlan }}
set interface state {{ v.from_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} up
set interface state {{ v.to_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} up
set interface l2 xconnect {{ v.from_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} {{ v.to_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }}
set interface l2 xconnect {{ v.to_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} {{ v.from_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }}
{% elif v.vlan_type == 'dot1ad' %}
# QinQ S-VLAN {{ v.vlan_id }} (all C-tags) {{ v.from_interface }} <-> {{ v.to_interface }}
create sub-interface {{ v.from_interface }} {{ v.vlan_id }} dot1ad
create sub-interface {{ v.to_interface }} {{ v.vlan_id }} dot1ad
set interface state {{ v.from_interface }}.{{ v.vlan_id }} up
set interface state {{ v.to_interface }}.{{ v.vlan_id }} up
set interface l2 xconnect {{ v.from_interface }}.{{ v.vlan_id }} {{ v.to_interface }}.{{ v.vlan_id }}
set interface l2 xconnect {{ v.to_interface }}.{{ v.vlan_id }} {{ v.from_interface }}.{{ v.vlan_id }}
{% else %}
# 802.1Q VLAN {{ v.vlan_id }} {{ v.from_interface }} <-> {{ v.to_interface }}
create sub-interface {{ v.from_interface }} {{ v.vlan_id }}
create sub-interface {{ v.to_interface }} {{ v.vlan_id }}
set interface state {{ v.from_interface }}.{{ v.vlan_id }} up
set interface state {{ v.to_interface }}.{{ v.vlan_id }} up
set interface l2 xconnect {{ v.from_interface }}.{{ v.vlan_id }} {{ v.to_interface }}.{{ v.vlan_id }}
set interface l2 xconnect {{ v.to_interface }}.{{ v.vlan_id }} {{ v.from_interface }}.{{ v.vlan_id }}
{% endif %}
{% endfor %}
{% endif %}

# IPv6 Router Advertisement Configuration
{% for iface in interfaces %}
{% if iface.ipv6 and iface.ipv6_ra_enabled %}
{% set ra_prefixes = iface.ipv6_ra_prefixes if iface.ipv6_ra_prefixes else iface.ipv6_ra_prefixes_auto %}
# RA on {{ iface.name }}
ip6 nd {{ iface.name }} ra-interval {{ iface.ipv6_ra_interval_max }} {{ iface.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
ip6 nd {{ iface.name }} prefix {{ prefix }} infinite infinite off-link
{% endfor %}
{% if not iface.ipv6_ra_suppress %}
ip6 nd {{ iface.name }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for lo in loopbacks %}
{% if lo.ipv6 and lo.create_lcp and lo.ipv6_ra_enabled %}
{% set ra_prefixes = lo.ipv6_ra_prefixes if lo.ipv6_ra_prefixes else [lo.ipv6 ~ '/' ~ lo.ipv6_prefix] %}
# RA on loop{{ lo.instance }}
ip6 nd loop{{ lo.instance }} ra-interval {{ lo.ipv6_ra_interval_max }} {{ lo.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
ip6 nd loop{{ lo.instance }} prefix {{ prefix }} infinite infinite off-link
{% endfor %}
{% if not lo.ipv6_ra_suppress %}
ip6 nd loop{{ lo.instance }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for bvi in bvi_domains %}
{% if bvi.ipv6 and bvi.create_lcp and bvi.ipv6_ra_enabled %}
{% set ra_prefixes = bvi.ipv6_ra_prefixes if bvi.ipv6_ra_prefixes else [bvi.ipv6 ~ '/' ~ bvi.ipv6_prefix] %}
# RA on bvi{{ bvi.bridge_id }}
ip6 nd loop{{ bvi.bridge_id }} ra-interval {{ bvi.ipv6_ra_interval_max }} {{ bvi.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
ip6 nd loop{{ bvi.bridge_id }} prefix {{ prefix }} infinite infinite off-link
{% endfor %}
{% if not bvi.ipv6_ra_suppress %}
ip6 nd loop{{ bvi.bridge_id }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for iface in interfaces %}
{% for sub in iface.subinterfaces %}
{% if sub.ipv6 and sub.create_lcp and sub.ipv6_ra_enabled %}
{% set ra_prefixes = sub.ipv6_ra_prefixes if sub.ipv6_ra_prefixes else [sub.ipv6 ~ '/' ~ sub.ipv6_prefix] %}
# RA on {{ iface.name }}.{{ sub.vlan_id }}
ip6 nd {{ iface.name }}.{{ sub.vlan_id }} ra-interval {{ sub.ipv6_ra_interval_max }} {{ sub.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
ip6 nd {{ iface.name }}.{{ sub.vlan_id }} prefix {{ prefix }} infinite infinite off-link
{% endfor %}
{% if not sub.ipv6_ra_suppress %}
ip6 nd {{ iface.name }}.{{ sub.vlan_id }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
