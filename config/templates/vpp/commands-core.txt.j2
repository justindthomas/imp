# VPP Core Commands
# Generated by configure-router.py

lcp lcp-sync on
lcp lcp-auto-subint on

# External interface
lcp create external host-if external
set interface state external up
set interface ip address external {{ external.ipv4 }}/{{ external.ipv4_prefix }}
{% if external.ipv6 %}
set interface ip address external {{ external.ipv6 }}/{{ external.ipv6_prefix }}
{% endif %}
set interface mtu 1500 external
{% if external.subinterfaces %}

# External sub-interfaces (L3 VLAN termination)
{% for sub in external.subinterfaces %}
create sub-interfaces external {{ sub.vlan_id }}
set interface state external.{{ sub.vlan_id }} up
{% if sub.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create external.{{ sub.vlan_id }} host-if ext-v{{ sub.vlan_id }}
{% endif %}
{% if sub.ipv4 %}
set interface ip address external.{{ sub.vlan_id }} {{ sub.ipv4 }}/{{ sub.ipv4_prefix }}
{% endif %}
{% if sub.ipv6 %}
set interface ip address external.{{ sub.vlan_id }} {{ sub.ipv6 }}/{{ sub.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}

# Internal interfaces
{% for iface in internal %}
lcp create {{ iface.vpp_name }} host-if {{ iface.vpp_name }}
set interface state {{ iface.vpp_name }} up
set interface ip address {{ iface.vpp_name }} {{ iface.ipv4 }}/{{ iface.ipv4_prefix }}
{% if iface.ipv6 %}
set interface ip address {{ iface.vpp_name }} {{ iface.ipv6 }}/{{ iface.ipv6_prefix }}
{% endif %}
set interface mtu 1500 {{ iface.vpp_name }}
{% if iface.subinterfaces %}

# {{ iface.vpp_name }} sub-interfaces (L3 VLAN termination)
{% for sub in iface.subinterfaces %}
create sub-interfaces {{ iface.vpp_name }} {{ sub.vlan_id }}
set interface state {{ iface.vpp_name }}.{{ sub.vlan_id }} up
{% if sub.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create {{ iface.vpp_name }}.{{ sub.vlan_id }} host-if {{ iface.vpp_name }}-v{{ sub.vlan_id }}
{% endif %}
{% if sub.ipv4 %}
set interface ip address {{ iface.vpp_name }}.{{ sub.vlan_id }} {{ sub.ipv4 }}/{{ sub.ipv4_prefix }}
{% endif %}
{% if sub.ipv6 %}
set interface ip address {{ iface.vpp_name }}.{{ sub.vlan_id }} {{ sub.ipv6 }}/{{ sub.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}

{% endfor %}
{% if loopbacks %}
# Loopback interfaces
{% for lo in loopbacks %}
create loopback interface instance {{ lo.instance }}
set interface state loop{{ lo.instance }} up
{% if lo.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create loop{{ lo.instance }} host-if lo{{ lo.instance }}
{% endif %}
{% if lo.ipv4 %}
set interface ip address loop{{ lo.instance }} {{ lo.ipv4 }}/{{ lo.ipv4_prefix }}
{% endif %}
{% if lo.ipv6 %}
set interface ip address loop{{ lo.instance }} {{ lo.ipv6 }}/{{ lo.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}
{% if bvi_domains %}

# BVI (Bridge Virtual Interface) domains
{% for bvi in bvi_domains %}
# Bridge domain {{ bvi.bridge_id }}: {{ bvi.name }}
create loopback interface instance {{ bvi.bridge_id }}
set interface state loop{{ bvi.bridge_id }} up
create bridge-domain {{ bvi.bridge_id }}
set interface l2 bridge loop{{ bvi.bridge_id }} {{ bvi.bridge_id }} bvi
{% for member in bvi.members %}
{% if member.vlan_id %}
create sub-interfaces {{ member.interface }} {{ member.vlan_id }}
set interface state {{ member.interface }}.{{ member.vlan_id }} up
set interface l2 bridge {{ member.interface }}.{{ member.vlan_id }} {{ bvi.bridge_id }}
{% else %}
set interface l2 bridge {{ member.interface }} {{ bvi.bridge_id }}
{% endif %}
{% endfor %}
{% if bvi.create_lcp %}
{# Create LCP BEFORE IPs so linux_cp syncs addresses to Linux #}
lcp create loop{{ bvi.bridge_id }} host-if bvi{{ bvi.bridge_id }}
{% endif %}
{% if bvi.ipv4 %}
set interface ip address loop{{ bvi.bridge_id }} {{ bvi.ipv4 }}/{{ bvi.ipv4_prefix }}
{% endif %}
{% if bvi.ipv6 %}
set interface ip address loop{{ bvi.bridge_id }} {{ bvi.ipv6 }}/{{ bvi.ipv6_prefix }}
{% endif %}
{% endfor %}
{% endif %}

# Memif to NAT instance (internal side)
create memif socket id 1 filename /run/vpp/memif-nat-int.sock
create interface memif id 0 socket-id 1 master
set interface state memif1/0 up
set interface ip address memif1/0 169.254.1.4/31

# Memif to NAT instance (external side)
create memif socket id 2 filename /run/vpp/memif-nat-ext.sock
create interface memif id 0 socket-id 2 master
lcp create memif2/0 host-if memif2
set interface state memif2/0 up
set interface ip address memif2/0 169.254.1.7/31

# ACL-based forwarding to NAT for internal networks
# Each internal network gets an ACL that:
# - Denies traffic to container network (stays local)
# - Denies traffic to specific bypass pairs (direct routing)
# - Permits everything else (goes to NAT)
{% for iface in internal %}
set acl-plugin acl deny src {{ iface.network }} dst {{ container.network }}{% for bp in nat.bypass_pairs %}, deny src {{ bp.source }} dst {{ bp.destination }}{% endfor %}, permit src {{ iface.network }}
abf policy add id {{ loop.index0 }} acl {{ loop.index0 }} via 169.254.1.5 memif1/0
abf attach ip4 policy {{ loop.index0 }} {{ iface.vpp_name }}
{% endfor %}

# Default routes
ip route add 0.0.0.0/0 via {{ external.ipv4_gateway }} external
{% if external.ipv6_gateway %}
ip route add ::/0 via {{ external.ipv6_gateway }} external
{% endif %}

# Route for NAT pool (via NAT instance)
ip route add {{ nat.bgp_prefix }} via 169.254.1.6 memif2/0
{% if vlan_passthrough %}

# VLAN pass-through (L2 cross-connect between external and internal interfaces)
{% for v in vlan_passthrough %}
{% if v.inner_vlan %}
# QinQ VLAN {{ v.vlan_id }}.{{ v.inner_vlan }} <-> {{ v.internal_interface }}
create sub-interface external {{ v.vlan_id }} inner-dot1q {{ v.inner_vlan }}
create sub-interface {{ v.internal_interface }} {{ v.vlan_id }} inner-dot1q {{ v.inner_vlan }}
set interface state external.{{ v.vlan_id }}.{{ v.inner_vlan }} up
set interface state {{ v.internal_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} up
set interface l2 xconnect external.{{ v.vlan_id }}.{{ v.inner_vlan }} {{ v.internal_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }}
set interface l2 xconnect {{ v.internal_interface }}.{{ v.vlan_id }}.{{ v.inner_vlan }} external.{{ v.vlan_id }}.{{ v.inner_vlan }}
{% elif v.vlan_type == 'dot1ad' %}
# QinQ S-VLAN {{ v.vlan_id }} (all C-tags) <-> {{ v.internal_interface }}
create sub-interface external {{ v.vlan_id }} dot1ad
create sub-interface {{ v.internal_interface }} {{ v.vlan_id }} dot1ad
set interface state external.{{ v.vlan_id }} up
set interface state {{ v.internal_interface }}.{{ v.vlan_id }} up
set interface l2 xconnect external.{{ v.vlan_id }} {{ v.internal_interface }}.{{ v.vlan_id }}
set interface l2 xconnect {{ v.internal_interface }}.{{ v.vlan_id }} external.{{ v.vlan_id }}
{% else %}
# 802.1Q VLAN {{ v.vlan_id }} <-> {{ v.internal_interface }}
create sub-interface external {{ v.vlan_id }}
create sub-interface {{ v.internal_interface }} {{ v.vlan_id }}
set interface state external.{{ v.vlan_id }} up
set interface state {{ v.internal_interface }}.{{ v.vlan_id }} up
set interface l2 xconnect external.{{ v.vlan_id }} {{ v.internal_interface }}.{{ v.vlan_id }}
set interface l2 xconnect {{ v.internal_interface }}.{{ v.vlan_id }} external.{{ v.vlan_id }}
{% endif %}
{% endfor %}
{% endif %}
