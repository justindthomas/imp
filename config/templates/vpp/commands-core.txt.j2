# VPP Core Commands
# Generated by configure-router.py

lcp lcp-sync on
lcp lcp-auto-subint on

# External interface
lcp create external host-if external
set interface state external up
set interface ip address external {{ external.ipv4 }}/{{ external.ipv4_prefix }}
{% if external.ipv6 %}
set interface ip address external {{ external.ipv6 }}/{{ external.ipv6_prefix }}
{% endif %}
set interface mtu 1500 external

# Internal interfaces
{% for iface in internal %}
lcp create {{ iface.vpp_name }} host-if {{ iface.vpp_name }}
set interface state {{ iface.vpp_name }} up
set interface ip address {{ iface.vpp_name }} {{ iface.ipv4 }}/{{ iface.ipv4_prefix }}
{% if iface.ipv6 %}
set interface ip address {{ iface.vpp_name }} {{ iface.ipv6 }}/{{ iface.ipv6_prefix }}
{% endif %}
set interface mtu 1500 {{ iface.vpp_name }}

{% endfor %}
# Memif to NAT instance (internal side)
create memif socket id 1 filename /run/vpp/memif-nat-int.sock
create interface memif id 0 socket-id 1 master
set interface state memif1/0 up
set interface ip address memif1/0 169.254.1.4/31

# Memif to NAT instance (external side)
create memif socket id 2 filename /run/vpp/memif-nat-ext.sock
create interface memif id 0 socket-id 2 master
lcp create memif2/0 host-if memif2
set interface state memif2/0 up
set interface ip address memif2/0 169.254.1.7/31

# ACL-based forwarding to NAT for internal networks
# Each internal network gets an ACL that:
# - Denies traffic to container network (stays local)
# - Denies traffic to other RFC1918 (hairpin prevention)
# - Permits everything else (goes to NAT)
{% for iface in internal %}
set acl-plugin acl deny src {{ iface.network }} dst {{ container.network }}, deny src {{ iface.network }} dst 192.168.0.0/16, deny src {{ iface.network }} dst 172.16.0.0/12, deny src {{ iface.network }} dst 10.0.0.0/8, permit src {{ iface.network }}
abf policy add id {{ loop.index0 }} acl {{ loop.index0 }} via 169.254.1.5 memif1/0
abf attach ip4 policy {{ loop.index0 }} {{ iface.vpp_name }}
{% endfor %}

# Default routes
ip route add 0.0.0.0/0 via {{ external.ipv4_gateway }} external
{% if external.ipv6_gateway %}
ip route add ::/0 via {{ external.ipv6_gateway }} external
{% endif %}

# Route for NAT pool (via NAT instance)
ip route add {{ nat.pool }} via 169.254.1.6 memif2/0
