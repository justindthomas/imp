#!/usr/bin/env bash
#
# Incus Container Networking Setup
# Generated by configure-router.sh
#
# Creates veth pair to bridge Incus containers to VPP
#

export CMD="vppctl -s /run/vpp/core-cli.sock"

# Create veth pair
ip link add incus-host type veth peer name incus-dataplane
ip link set incus-host master incusbr0
ip link set incus-host up
ip link set incus-dataplane netns dataplane
ip netns exec dataplane ip link set incus-dataplane up

# Create host interface in VPP
$CMD create host-interface name incus-dataplane
$CMD set int state host-incus-dataplane up
$CMD set int ip address host-incus-dataplane ${CONTAINER_GATEWAY}/${CONTAINER_PREFIX}
{{CONTAINER_IPV6_CMD}}

# ACL to steer container traffic to NAT
$CMD set acl-plugin acl deny src ${CONTAINER_NETWORK} dst 192.168.0.0/16, deny src ${CONTAINER_NETWORK} dst 172.16.0.0/12, deny src ${CONTAINER_NETWORK} dst 10.0.0.0/8, permit src ${CONTAINER_NETWORK}
$CMD abf policy add id 1 acl 1 via 169.254.1.5 memif1/0
$CMD abf attach ip4 policy 1 host-incus-dataplane

sleep 15

# IPv6 RA for containers
{{CONTAINER_IPV6_RA}}
