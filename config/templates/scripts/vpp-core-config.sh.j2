#!/usr/bin/env bash
#
# VPP Core Post-Configuration
# Generated by configure-router.py
#
# This script runs after VPP has started to configure features that need
# the dataplane to be fully initialized (like IPv6 Router Advertisements).
#

set -e

CMD="vppctl -s /run/vpp/core-cli.sock"

# Wait for VPP CLI to be available
for i in {1..30}; do
    if $CMD show version > /dev/null 2>&1; then
        break
    fi
    sleep 1
done

# Wait for interfaces to fully initialize
sleep 2

# IPv6 Router Advertisement Configuration
{% for iface in interfaces %}
{% if iface.ipv6 and iface.ipv6_ra_enabled %}
{% set ra_prefixes = iface.ipv6_ra_prefixes if iface.ipv6_ra_prefixes else iface.ipv6_ra_prefixes_auto %}
# RA on {{ iface.name }}
$CMD ip6 nd {{ iface.name }} ra-interval {{ iface.ipv6_ra_interval_max }} {{ iface.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
$CMD ip6 nd {{ iface.name }} prefix {{ prefix }} infinite
{% endfor %}
{% if not iface.ipv6_ra_suppress %}
$CMD ip6 nd {{ iface.name }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for lo in loopbacks %}
{% if lo.ipv6 and lo.create_lcp and lo.ipv6_ra_enabled %}
{% set ra_prefixes = lo.ipv6_ra_prefixes if lo.ipv6_ra_prefixes else [lo.ipv6 ~ '/' ~ lo.ipv6_prefix] %}
# RA on loop{{ lo.instance }}
$CMD ip6 nd loop{{ lo.instance }} ra-interval {{ lo.ipv6_ra_interval_max }} {{ lo.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
$CMD ip6 nd loop{{ lo.instance }} prefix {{ prefix }} infinite
{% endfor %}
{% if not lo.ipv6_ra_suppress %}
$CMD ip6 nd loop{{ lo.instance }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for bvi in bvi_domains %}
{% if bvi.ipv6 and bvi.create_lcp and bvi.ipv6_ra_enabled %}
{% set ra_prefixes = bvi.ipv6_ra_prefixes if bvi.ipv6_ra_prefixes else [bvi.ipv6 ~ '/' ~ bvi.ipv6_prefix] %}
# RA on bvi{{ bvi.bridge_id }}
$CMD ip6 nd loop{{ bvi.bridge_id }} ra-interval {{ bvi.ipv6_ra_interval_max }} {{ bvi.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
$CMD ip6 nd loop{{ bvi.bridge_id }} prefix {{ prefix }} infinite
{% endfor %}
{% if not bvi.ipv6_ra_suppress %}
$CMD ip6 nd loop{{ bvi.bridge_id }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% for iface in interfaces %}
{% for sub in iface.subinterfaces %}
{% if sub.ipv6 and sub.create_lcp and sub.ipv6_ra_enabled %}
{% set ra_prefixes = sub.ipv6_ra_prefixes if sub.ipv6_ra_prefixes else [sub.ipv6 ~ '/' ~ sub.ipv6_prefix] %}
# RA on {{ iface.name }}.{{ sub.vlan_id }}
$CMD ip6 nd {{ iface.name }}.{{ sub.vlan_id }} ra-interval {{ sub.ipv6_ra_interval_max }} {{ sub.ipv6_ra_interval_min }}
{% for prefix in ra_prefixes %}
$CMD ip6 nd {{ iface.name }}.{{ sub.vlan_id }} prefix {{ prefix }} infinite
{% endfor %}
{% if not sub.ipv6_ra_suppress %}
$CMD ip6 nd {{ iface.name }}.{{ sub.vlan_id }} no ra-suppress
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}

exit 0
