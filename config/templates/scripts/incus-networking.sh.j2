#!/usr/bin/env bash
#
# Incus Container Networking Setup
# Generated by configure-router.py
#
# Creates veth pair to bridge Incus containers to VPP
#

export CMD="vppctl -s /run/vpp/core-cli.sock"

# Create veth pair
ip link add incus-host type veth peer name incus-dataplane
ip link set incus-host master incusbr0
ip link set incus-host up
ip link set incus-dataplane netns dataplane
ip netns exec dataplane ip link set incus-dataplane up

# Create host interface in VPP
$CMD create host-interface name incus-dataplane
$CMD set int state host-incus-dataplane up
$CMD set int ip address host-incus-dataplane {{ container.gateway }}/{{ container.prefix }}
{% if container.ipv6 %}
$CMD set int ip address host-incus-dataplane {{ container.ipv6 }}/{{ container.ipv6_prefix }}
{% endif %}

# ACL to steer container traffic to NAT
$CMD set acl-plugin acl deny src {{ container.network }} dst 192.168.0.0/16, deny src {{ container.network }} dst 172.16.0.0/12, deny src {{ container.network }} dst 10.0.0.0/8, permit src {{ container.network }}
$CMD abf policy add id {{ internal | length }} acl {{ internal | length }} via 169.254.1.5 memif1/0
$CMD abf attach ip4 policy {{ internal | length }} host-incus-dataplane

sleep 15

# IPv6 RA for containers
{% if container.ipv6 %}
$CMD ip6 nd host-incus-dataplane ra-interval 30 15
$CMD ip6 nd host-incus-dataplane prefix {{ container.ipv6_ra_prefix }} infinite
$CMD ip6 nd host-incus-dataplane no ra-suppress
{% endif %}
