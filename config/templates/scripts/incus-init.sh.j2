#!/bin/bash
#
# incus-init.sh - Initialize Incus for IMP dataplane integration
# Generated by configure-router.py
#
# This script initializes Incus with the correct network configuration
# for VPP integration.
#

set -euo pipefail

echo "Initializing Incus for IMP..."

# Check if Incus is already initialized
if incus network show incusbr0 &>/dev/null; then
    echo "Incus already initialized, updating network configuration..."
else
    echo "Running incus admin init..."
    # Preseed with network configuration from router config
    cat <<EOF | incus admin init --preseed
config: {}
networks:
- config:
    ipv4.address: {{ container.bridge_ip }}/{{ container.prefix }}
    ipv4.nat: "false"
    ipv4.dhcp: "true"
    ipv4.dhcp.gateway: {{ container.gateway }}
    ipv4.dhcp.ranges: {{ container.dhcp_start }}-{{ container.dhcp_end }}
{% if container.ipv6 %}
    ipv6.address: {{ container.bridge_ipv6 }}/{{ container.ipv6_prefix }}
    ipv6.nat: "false"
{% else %}
    ipv6.address: none
{% endif %}
  description: "IMP container bridge"
  name: incusbr0
  type: bridge
storage_pools:
- config: {}
  description: ""
  name: default
  driver: dir
profiles:
- config: {}
  description: ""
  devices:
    eth0:
      name: eth0
      network: incusbr0
      type: nic
    root:
      path: /
      pool: default
      type: disk
  name: default
EOF
fi

# Ensure settings are correct (idempotent)
echo "Applying network settings..."
incus network set incusbr0 ipv4.nat=false
incus network set incusbr0 ipv4.dhcp=true
incus network set incusbr0 ipv4.dhcp.gateway={{ container.gateway }}
incus network set incusbr0 ipv4.dhcp.ranges="{{ container.dhcp_start }}-{{ container.dhcp_end }}"
{% if container.ipv6 %}
# IPv6 uses SLAAC - containers auto-configure from RA
incus network set incusbr0 ipv6.nat=false
{% else %}
incus network set incusbr0 ipv6.address=none
{% endif %}

echo ""
echo "Incus network configuration:"
incus network show incusbr0

echo ""
echo "Incus initialization complete."
